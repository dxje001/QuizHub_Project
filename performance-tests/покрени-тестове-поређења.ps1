# ะะพะผะฟะปะตัะฐะฝ ะฟะฐะบะตั ะทะฐ ัะตััะธัะฐัะต ะฟะตััะพัะผะฐะฝัะธ
# ะะพัะตะดะธ ะผะพะฝะพะปะธั vs ะผะธะบัะพัะตัะฒะธัะต ะฟะพะด ัะฐะทะปะธัะธัะธะผ ะพะฟัะตัะตัะตัะธะผะฐ

param(
    [switch]$ะัะตัะบะพัะธะะพะฝะพะปะธั,
    [switch]$ะัะตัะบะพัะธะะธะบัะพัะตัะฒะธัะต,
    [int]$ะะฐะบัะะพัะธัะฝะธะบะฐ = 50
)

$K6_PATH = "C:\Program Files\k6\k6.exe"
$MONOLITH_URL = "http://localhost:8080"
$MICROSERVICES_URL = "http://54.196.182.219"

Write-Host "`nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Cyan
Write-Host "โ  ะขะตััะธัะฐัะต ะฟะตััะพัะผะฐะฝัะธ ะะฒะธะทะฅะฐะฑ            โ" -ForegroundColor Cyan
Write-Host "โ  ะะพะฝะพะปะธั vs ะะธะบัะพัะตัะฒะธัะธ                   โ" -ForegroundColor Cyan
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`n" -ForegroundColor Cyan

# ะกัะตะฝะฐัะธัะธ ัะตััะธัะฐัะฐ
$ััะตะฝะฐัะธัะธ = @(
    @{ ะะผะต = "light_load"; ะะพัะธัะฝะธัะธ = 5; ะขัะฐัะฐัะต = "2m"; ะะฟะธั = "ะะฐะบะพ ะพะฟัะตัะตัะตัะต (5 ะบะพัะธัะฝะธะบะฐ)" },
    @{ ะะผะต = "medium_load"; ะะพัะธัะฝะธัะธ = 20; ะขัะฐัะฐัะต = "2m"; ะะฟะธั = "ะกัะตะดัะต ะพะฟัะตัะตัะตัะต (20 ะบะพัะธัะฝะธะบะฐ)" },
    @{ ะะผะต = "heavy_load"; ะะพัะธัะฝะธัะธ = 50; ะขัะฐัะฐัะต = "2m"; ะะฟะธั = "ะขะตัะบะพ ะพะฟัะตัะตัะตัะต (50 ะบะพัะธัะฝะธะบะฐ)" }
)

# ะคัะฝะบัะธัะฐ ะทะฐ ะฟะพะบัะตัะฐัะต ัะตััะฐ
function ะะพะบัะตะฝะธ-ะขะตัั {
    param($ะััะธัะตะบัััะฐ, $ะฃะะ, $ะกัะตะฝะฐัะธะพ)

    Write-Host "`n๐ ะขะตััะธัะฐัะต: $ะััะธัะตะบัััะฐ - $($ะกัะตะฝะฐัะธะพ.ะะฟะธั)" -ForegroundColor Yellow
    Write-Host "   ะฃะะ: $ะฃะะ" -ForegroundColor Gray
    Write-Host "   ะะพัะธัะฝะธัะธ: $($ะกัะตะฝะฐัะธะพ.ะะพัะธัะฝะธัะธ) | ะขัะฐัะฐัะต: $($ะกัะตะฝะฐัะธะพ.ะขัะฐัะฐัะต)" -ForegroundColor Gray
    Write-Host ""

    $env:BASE_URL = $ะฃะะ
    $env:TEST_NAME = $ะััะธัะตะบัััะฐ
    $env:SCENARIO = $ะกัะตะฝะฐัะธะพ.ะะผะต

    & $K6_PATH run test-scenarios.js

    Write-Host "`nโ ะขะตัั ะทะฐะฒััะตะฝ!" -ForegroundColor Green
}

# ะัะพะฒะตัะฐ ะดะฐ ะปะธ ัะต ะ6 ะธะฝััะฐะปะธัะฐะฝ
if (-not (Test-Path $K6_PATH)) {
    Write-Host "โ ะ6 ะฝะธัะต ะฟัะพะฝะฐัะตะฝ ะฝะฐ $K6_PATH" -ForegroundColor Red
    Write-Host "   ะะฝััะฐะปะธัะฐััะต ัะฐ: winget install k6" -ForegroundColor Yellow
    exit 1
}

# ะัะพะฒะตัะฐ ะผะพะฝะพะปะธัะฐ
if (-not $ะัะตัะบะพัะธะะพะฝะพะปะธั) {
    Write-Host "ะัะพะฒะตัะฐะฒะฐัะต ะดะพัััะฟะฝะพััะธ ะผะพะฝะพะปะธัะฐ..." -ForegroundColor Yellow
    try {
        $ะพะดะณะพะฒะพั = Invoke-WebRequest -Uri "$MONOLITH_URL/api/quiz" -Method GET -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop
        Write-Host "โ ะะพะฝะพะปะธั ัะฐะดะธ" -ForegroundColor Green
    } catch {
        Write-Host "โ ะะพะฝะพะปะธั ะฝะต ะพะดะณะพะฒะฐัะฐ ะฝะฐ $MONOLITH_URL" -ForegroundColor Red
        Write-Host "   ะะพะบัะตะฝะธัะต ะณะฐ ัะฐ: docker-compose up -d" -ForegroundColor Yellow
        $ะพะดะณะพะฒะพั = Read-Host "`nะะฐััะฐะฒะธัะธ ะฑะตะท ัะตััะพะฒะฐ ะผะพะฝะพะปะธัะฐ? (ะด/ะฝ)"
        if ($ะพะดะณะพะฒะพั -ne 'ะด') { exit 1 }
        $ะัะตัะบะพัะธะะพะฝะพะปะธั = $true
    }
}

# ะัะพะฒะตัะฐ ะผะธะบัะพัะตัะฒะธัะฐ
if (-not $ะัะตัะบะพัะธะะธะบัะพัะตัะฒะธัะต) {
    Write-Host "ะัะพะฒะตัะฐะฒะฐัะต ะดะพัััะฟะฝะพััะธ ะผะธะบัะพัะตัะฒะธัะฐ..." -ForegroundColor Yellow
    try {
        $ะพะดะณะพะฒะพั = Invoke-WebRequest -Uri "$MICROSERVICES_URL/health" -Method GET -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop
        Write-Host "โ ะะธะบัะพัะตัะฒะธัะธ ัะฐะดะต" -ForegroundColor Green
    } catch {
        Write-Host "โ ะะธะบัะพัะตัะฒะธัะธ ะฝะต ะพะดะณะพะฒะฐัะฐัั ะฝะฐ $MICROSERVICES_URL" -ForegroundColor Red
        Write-Host "   ะัะพะฒะตัะธัะต AWS ะะฆ2 ะธะฝััะฐะฝัั" -ForegroundColor Yellow
        $ะพะดะณะพะฒะพั = Read-Host "`nะะฐััะฐะฒะธัะธ ะฑะตะท ัะตััะพะฒะฐ ะผะธะบัะพัะตัะฒะธัะฐ? (ะด/ะฝ)"
        if ($ะพะดะณะพะฒะพั -ne 'ะด') { exit 1 }
        $ะัะตัะบะพัะธะะธะบัะพัะตัะฒะธัะต = $true
    }
}

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "ะะพัะตัะฐะบ ะฟะฐะบะตัะฐ ัะตััะพะฒะฐ" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

$ัะบัะฟะฝะพะขะตััะพะฒะฐ = 0
$ะทะฐะฒััะตะฝะธัะขะตััะพะฒะฐ = 0

# ะัะตะฑัะพัะฐะฒะฐัะต ัะบัะฟะฝะธั ัะตััะพะฒะฐ
foreach ($ััะตะฝะฐัะธะพ in $ััะตะฝะฐัะธัะธ) {
    if (-not $ะัะตัะบะพัะธะะพะฝะพะปะธั) { $ัะบัะฟะฝะพะขะตััะพะฒะฐ++ }
    if (-not $ะัะตัะบะพัะธะะธะบัะพัะตัะฒะธัะต) { $ัะบัะฟะฝะพะขะตััะพะฒะฐ++ }
}

Write-Host "ะฃะบัะฟะฝะพ ัะตััะพะฒะฐ: $ัะบัะฟะฝะพะขะตััะพะฒะฐ" -ForegroundColor White
Write-Host "ะัะพัะตัะตะฝะพ ะฒัะตะผะต: $($ัะบัะฟะฝะพะขะตััะพะฒะฐ * 2) ะผะธะฝััะฐ`n" -ForegroundColor Gray

# ะะพะบัะตัะฐัะต ัะตััะพะฒะฐ ะทะฐ ัะฒะฐะบะธ ััะตะฝะฐัะธะพ
foreach ($ััะตะฝะฐัะธะพ in $ััะตะฝะฐัะธัะธ) {
    Write-Host "`nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Cyan
    Write-Host " ะกะฆะะะะะะ: $($ััะตะฝะฐัะธะพ.ะะฟะธั)" -ForegroundColor Cyan
    Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`n" -ForegroundColor Cyan

    # ะขะตััะธัะฐัะต ะผะพะฝะพะปะธัะฐ
    if (-not $ะัะตัะบะพัะธะะพะฝะพะปะธั) {
        ะะพะบัะตะฝะธ-ะขะตัั -ะััะธัะตะบัััะฐ "monolith" -ะฃะะ $MONOLITH_URL -ะกัะตะฝะฐัะธะพ $ััะตะฝะฐัะธะพ
        $ะทะฐะฒััะตะฝะธัะขะตััะพะฒะฐ++
        Write-Host "`nะะฐะฟัะตะดะฐะบ: $ะทะฐะฒััะตะฝะธัะขะตััะพะฒะฐ/$ัะบัะฟะฝะพะขะตััะพะฒะฐ ัะตััะพะฒะฐ ะทะฐะฒััะตะฝะพ" -ForegroundColor Gray
        Start-Sleep -Seconds 10  # ะะตัะธะพะด ัะปะฐัะตัะฐ
    }

    # ะขะตััะธัะฐัะต ะผะธะบัะพัะตัะฒะธัะฐ
    if (-not $ะัะตัะบะพัะธะะธะบัะพัะตัะฒะธัะต) {
        ะะพะบัะตะฝะธ-ะขะตัั -ะััะธัะตะบัััะฐ "microservices" -ะฃะะ $MICROSERVICES_URL -ะกัะตะฝะฐัะธะพ $ััะตะฝะฐัะธะพ
        $ะทะฐะฒััะตะฝะธัะขะตััะพะฒะฐ++
        Write-Host "`nะะฐะฟัะตะดะฐะบ: $ะทะฐะฒััะตะฝะธัะขะตััะพะฒะฐ/$ัะบัะฟะฝะพะขะตััะพะฒะฐ ัะตััะพะฒะฐ ะทะฐะฒััะตะฝะพ" -ForegroundColor Gray
        Start-Sleep -Seconds 10  # ะะตัะธะพะด ัะปะฐัะตัะฐ
    }
}

Write-Host "`nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" -ForegroundColor Green
Write-Host "โ       ะกะะ ะขะะกะขะะะ ะะะะะจะะะ! โ              โ" -ForegroundColor Green
Write-Host "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`n" -ForegroundColor Green

Write-Host "ะะตะทัะปัะฐัะธ ัะฐััะฒะฐะฝะธ ั ะะกะะ ัะฐัะปะพะฒะธะผะฐ:" -ForegroundColor Cyan
Get-ChildItem -Path "." -Filter "results-*.json" | ForEach-Object {
    Write-Host "  - $($_.Name)" -ForegroundColor White
}

Write-Host "`n๐ ะกะปะตะดะตัะธ ะบะพัะฐัะธ:" -ForegroundColor Yellow
Write-Host "  1. ะะพะบัะตะฝะธัะต: python ะฐะฝะฐะปะธะทะฐ-ัะตะทัะปัะฐัะฐ.py" -ForegroundColor White
Write-Host "  2. ะัะพะฒะตัะธัะต: ะธะทะฒะตััะฐั-ะฟะพัะตัะตัะฐ.html" -ForegroundColor White
Write-Host "  3. ะฃะบัััะธัะต ะณัะฐัะธะบะพะฝะต ั ะฒะฐั ัะฐะด!`n" -ForegroundColor White
